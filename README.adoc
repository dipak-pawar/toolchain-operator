= Toolchain Operator
:toc:
:toc-placement: preamble
:sectnums:
:experimental:

image:https://ci.centos.org/buildStatus/icon?job=devtools-toolchain-operator-build-master[Jenkins,link="https://ci.centos.org/view/Devtools/job/devtools-toolchain-operator-build-master/lastBuild/"]
image:https://goreportcard.com/badge/github.com/fabric8-services/toolchain-operator[Go Report Card, link="https://goreportcard.com/report/github.com/fabric8-services/toolchain-operator"]
image:https://godoc.org/github.com/fabric8-services/toolchain-operator?status.png[GoDoc,link="https://godoc.org/github.com/fabric8-services/toolchain-operator"]
image:https://codecov.io/gh/fabric8-services/toolchain-operator/branch/master/graph/badge.svg[Codecov.io,link="https://codecov.io/gh/fabric8-services/toolchain-operator"]


Operator to enable CodeReady Toolchain on OSD clusters

== Overview
To enable CodeReady Toolchain on any Openshift cluster, we need one time configuration setup which includes following things:

    * creation of service account with required roles
    * creation of oauth client
    * finding routing subdomain
    * finding cluster name and publicly available API URL

Once, we have above resources, we'll need to update this cluster information to the cluster management service, so that it can provision namespaces/projects to required users on this new cluster.

So in short this operator has to create required resources, find required cluster configuration details and update it to cluster management service.

Btw, cluster management service is interested in following information.

[source,json]
----
{
       "name":"us-east-2",
       "api-url":"https://api.starter-us-east-2.openshift.com",
       "app-dns":"8a09.starter-us-east-2.openshiftapps.com",
       "service-account-token":"fX0nH3d68LQ6SK5wBE6QeKJ6X8AZGVQO3dGQZZETakhmgmWAqr2KDFXE65KUwBO69aWoq",
       "service-account-username":"dsaas",
       "token-provider-id":"f867ac10-5e05-4359-a0c6-b855ece59090",
       "auth-client-id":"autheast2",
       "auth-client-secret":"autheast2secret",
       "auth-client-default-scope":"user:full"
}
----


== Building from source [[building]]

The following guide is mainly targeted towards a Linux machine.

=== Prerequisites [[prerequisites]]

You need to install:

* `go` (>= v1.11)
* `git`
* `mercurial`
* `make`
* `operator-sdk` (>= v0.4.0)

==== Check your Go version [[check-go-version]]

Run the following command to find out your Go version.

----
$ go version
----

*You must at least have Go version 1.11.*

See <<fetch-dependencies>> to see an explanaition on how we deal with
dependencies.

==== Install dep [[dep-setup]]

This project uses https://github.com/golang/dep[dep] as a package manager for Go.
Running the `make deps` command will install `dep` in `$GOPATH/bin` if it's not already available on your system.

==== Installing Operator-SDK
Follow https://github.com/operator-framework/operator-sdk#quick-start[this] guide to install operator-sdk

=== Get the code [[get-the-code]]

Assuming you have Go installed and configured (have `$GOPATH` setup) here is
how to build.

Check out the code

----
$ git clone https://github.com/fabric8-services/toolchain-operator $GOPATH/src/github.com/fabric8-services/toolchain-operator
----

=== Build [[build]]

Like most other projects, this one depends on various other projects that need
to be downloaded.


To fetch the dependencies and finally build the project you can type `make build` in a freshly clone repository of this project.

----
$ cd $GOPATH/src/github.com/fabric8-services/toolchain-operator
$ make build
----

==== Special make targets

There is no need to fetch the dependencies, or re-generate code every time you
want to compile. That's why we offer special `make` targets for these topics:

 * <<fetch-dependencies>>
 * <<build>>
 * <<clean>>
 * <<test>>

===== Fetch dependencies [[fetch-dependencies]]

This will download all the dependencies for this project inside a directory
called `vendor`. This way we can ensure that every developer and our CI system
is using the same version.

----
$ cd $GOPATH/src/github.com/fabric8-services/toolchain-operator
$ make deps
----

For dependency management of `go` packages we use https://github.com/golang/dep[`dep`].

The file `Gopkg.toml` contains all dependencies. If you want to understand the format for this file, look link:https://golang.github.io/dep/docs/Gopkg.toml.html[here].


===== Build [[build]]

If you want to just build the toolchain operator, run `make build`.

----
$ cd $GOPATH/src/github.com/fabric8-services/toolchain-operator
$ make build
----

===== Clean [[clean]]

This removes all downloaded dependencies, all generated code and compiled
artifacts.

----
$ cd $GOPATH/src/github.com/fabric8-services/toolchain-operator
$ make clean
----

===== Tests [[test]]

Here's how to run all available tests. All tests will check all Go packages
except those in the `vendor/` directory.

====== unit-tests
Unit tests have the minimum requirement on time and environment setup.

```bash
cd $GOPATH/src/github.com/fabric8-services/toolchain-operator
make test-unit
```

====== e2e-tests

*TL; DR*
```bash
make minishift-start
eval $(minishift docker-env)
cd $GOPATH/src/github.com/fabric8-services/toolchain-operator
make test-e2e
```

E2E tests are verifying successful deployment of Toolchain Operator and creation of required resources. End To end tests demand openshift cluster to be up and running.

However you can run minishift which is single node openshift cluster. You can check it using `minishift status`. If not then start it using `make minishift-start` target.

After successfully starting minishift, configure your shell to use docker daemon from minishift using `eval $(minishift docker-env)`.

Now it's time to run E2E tests for `toolchain-operator` which will create it's required resources from `deploy/test/` on OpenShift use following command:
```
make test-e2e
```

This make target is building new docker image `$(DOCKER_REPO)/$(IMAGE_NAME):test`(e.g. `quay.io/openshiftio/toolchain-operator:test`) which is used in the operator's deployment manifests in e2e tests.

Also remember that it uses the `system:admin` account for creating all required resources from `deploy/test` directory.

all::
To run both, the unit and the end to end tests you can run
+
----
$ cd $GOPATH/src/github.com/fabric8-services/toolchain-operator
$ make test-all
----

== Running On Minishift
Follow https://github.com/fabric8-services/toolchain-operator/blob/master/minishift/README.md[minishift] guide to run operator on minishift

== Developer
=== Code formatting

To check if the code is properly formatted run:
```
$ make check-go-format
```

To format the code:
```
$ make format-go-code
```

== Running in Openshift 4.x

To ship `toolchain-operator` from marketplace, we are bundling operator manifests with our own registry, where cluster-admin can create CatalogSource if needed and find our operator in operator catalogs.

We don't want to ship our operator to every cluster by default, this is why we are not going with default operatorsources which creates catalogsource for Community, RedHat, Certified operator registry.

=== Create, verify and push updated manifests to Registry

install operator-courier using:

`pip3 install operator-courier`

You can find more info about operator-couries at https://github.com/operator-framework/operator-courier.

==== Verify that your bundle has all required spec fields

`operator-courier verify deploy/olm-catalog/toolchain-enabler/`

==== Build and push registry image
`docker build -t quay.io/dipakpawar/toolchain-registry:v1 -f Dockerfile.registry .`

`docker push quay.io/dipakpawar/toolchain-registry:v1`

=== Login as cluster-admin

Make sure that you have logged in as cluster-admin to do following steps.

=== Create a Project
```
export namespace=toolchain-manager
oc new-project ${namespace}
```

=== Create CatalogSource, Subscription, OperatorGroup
```
# CatalogSource
cat <<EOF | oc create -f -
apiVersion: operators.coreos.com/v1alpha1
kind: CatalogSource
metadata:
  name: toolchain-operators
  namespace: ${namespace}
spec:
  sourceType: grpc
  image: quay.io/dipakpawar/toolchain-registry:v1
  displayName: Toolchain Operators
  publisher: Red Hat Developers
EOF

# Subscription
cat <<EOF | oc create -f -
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  generateName: toolchain-subscription
  namespace: ${namespace}
spec:
  source: toolchain-operators
  sourceNamespace: toolchain-manager
  name: toolchain
  startingCSV: toolchain-enabler.v0.0.1
  channel: alpha
EOF

# OperatorGroup
cat <<EOF | oc create -f -
apiVersion: operators.coreos.com/v1alpha2
kind: OperatorGroup
metadata:
  name: toolchain-operator
  namespace: ${namespace}
spec: {}
EOF
```

=== Create required secrets and configutation to run toolchain-operator
Toolchain operator assumes that cluster admin has created configmap and secrets with name `toolchain`
However you can create it using following:

```
cat <<EOF | oc create -f -
---
apiVersion: v1
kind: Secret
metadata:
  name: toolchain
  namespace: ${namespace}
type: Opaque
data:
  tc.client.id: YmI2ZDA0M2QtZjI0My00NThmLTg0OTgtMmMxOGExMmRjZjQ3
  tc.client.secret: c2VjcmV0
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: toolchain
  namespace: ${namespace}
data:
  auth.url: https://auth.openshift.io
  cluster.url: https://cluster.openshift.io
  cluster.name: "dsaas-stage" # this is workaround to run tests on minishift
---
EOF
```

=== Verification

==== Custom Resources
To verify that above resources has created, you can use following commands:

`oc get catalogsource,subscription,operatorgroup -n ${namespace}`

You should be able to see following output:

```
NAME                                                     NAME                  TYPE      PUBLISHER            AGE
catalogsource.operators.coreos.com/toolchain-operators   Toolchain Operators   grpc      Red Hat Developers   19h

NAME                                                            PACKAGE     SOURCE                CHANNEL
subscription.operators.coreos.com/toolchain-subscription7pgfm   toolchain   toolchain-operators   alpha

NAME                                                    AGE
operatorgroup.operators.coreos.com/toolchain-operator   19h
```

==== Service and Operator Registry

Verify that there is svc, pod created by CatalogSource to serve your operator in OperatorManagement -> Operator Catalogs

`oc get svc,po -n ${namespace}`

You should be able to see following output:
```
NAME                          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)     AGE
service/toolchain-operators   ClusterIP   172.30.13.112   <none>        50051/TCP   19h

NAME                                     READY     STATUS    RESTARTS   AGE
pod/toolchain-operators-djsvm            1/1       Running   0          19h

```

==== InstallPlan
Verify that you have installplan created in namespace given by ${namespace}.

`oc get installplan -n ${namespace}`

You should be able to see following output:
```
NAME            CSV                        SOURCE    APPROVAL    APPROVED
install-n26zf   toolchain-enabler.v0.0.1             Automatic   true
```

Make sure that it's Phase from status is complete, which means that it has created all required
resources defined in CSV and required to run operator like, sa, {cluster}role, {cluster}rolebinding.

==== SA, Role, RoleBinding, ClusterRole, ClusterRoleBinding.
Verify all resources defined in CSV is created. you can use following command

`oc get sa,role,rolebinding,clusterrole,clusterrolebinding -n ${namespace} | grep -E 'toolchain-enabler|NAME'`

You should be able to see following output:
```
NAME                               SECRETS   AGE
serviceaccount/toolchain-enabler   2         19h

NAME                                                            AGE
role.rbac.authorization.k8s.io/toolchain-enabler.v0.0.1-bntmz   19h

NAME                                                                                           AGE
rolebinding.rbac.authorization.k8s.io/toolchain-enabler.v0.0.1-bntmz-toolchain-enabler-htdn7   19h

NAME                                                                                                         AGE
clusterrole.rbac.authorization.k8s.io/toolchain-enabler.v0.0.1-wz7wj                                         19h

NAME                                                                                                                    AGE
clusterrolebinding.rbac.authorization.k8s.io/toolchain-enabler.v0.0.1-wz7wj-toolchain-enabler-v4nx9                     19h
```

==== Toolchain Operator Registry Pod and Toolchain operator deployment

Verify that operator deployment is created with given replica count and it's in running state.
`oc get deploy,po -n ${namespace}`

You should be able to see following output:

```
NAME                                      READY     UP-TO-DATE   AVAILABLE   AGE
deployment.extensions/toolchain-enabler   1/1       1            1           19h

NAME                                     READY     STATUS    RESTARTS   AGE
pod/toolchain-enabler-6d4f5df75d-8xkth   1/1       Running   0          19h
```

==== Create a custom resource and your operator will start executing reconcile logic

```
cat <<EOF | oc create -f -
apiVersion: codeready.io/v1alpha1
kind: ToolChainEnabler
metadata:
  name: toolchainenabler
  namespace: ${namespace}
spec:
EOF
```

See for logs using `oc logs toolchain-enabler-6d4f5df75d-8xkth -f -n ${namespace}`
